@model List<AWEfinal.UI.Models.CartItem>
@using System
@using System.Linq
@{
    ViewData["Title"] = "Shopping Cart";
    var subtotal = Model?.Sum(c => c.Subtotal) ?? 0m;
    var tax = Math.Round(subtotal * 0.10m, 2);
    var shipping = subtotal == 0m ? 0m : (subtotal >= 500m ? 0m : 15m);
    var grandTotal = subtotal + tax + shipping;
    var successMessage = TempData["SuccessMessage"] as string;
    var errorMessage = TempData["ErrorMessage"] as string;
}

<section class="awe-section">
    <div class="awe-section__header">
        <div>
            <h1 class="awe-section__title">Shopping cart &amp; checkout</h1>
            <p class="awe-section__subtitle">
                A layered, modern cart inspired by the EnhancedCartPage.tsx flowâ€”complete with tactile cards and responsive controls.
            </p>
        </div>
        <a class="awe-btn awe-btn--ghost" asp-controller="Product" asp-action="Index">Continue shopping</a>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="awe-toast awe-toast--success mb-3">
            <span>@successMessage</span>
            <i class="bi bi-check-circle-fill"></i>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="awe-toast awe-toast--error mb-3">
            <span>@errorMessage</span>
            <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
    }

    @if (Model == null || !Model.Any())
    {
        <div class="awe-empty-state">
            <h3>Your cart is empty</h3>
            <p class="awe-tagline">Add a few products to experience the full AWE cart journey.</p>
            <a class="awe-btn awe-btn--primary mt-3" asp-controller="Product" asp-action="Index">Browse products</a>
        </div>
    }
    else
    {
        <div class="awe-cart">
            <div class="awe-surface awe-cart__items">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 mb-0">Cart items (@Model.Count)</h2>
                    <span class="awe-tagline">Subtotal $@subtotal.ToString("N2")</span>
                </div>

                @foreach (var item in Model)
                {
                    <div class="awe-cart-item">
                        <div class="awe-cart-item__badge">
                            @item.Quantity x
                        </div>
                        <div class="awe-cart-item__info">
                            <div class="awe-cart-item__title">@item.ProductName</div>
                            <div class="awe-cart-item__meta">$@item.Price.ToString("N2") each</div>
                            <div class="awe-cart-item__meta">Subtotal $@item.Subtotal.ToString("N2")</div>
                            <div class="awe-cart-item__actions">
                                <form method="post" asp-action="UpdateCart" class="awe-cart-item__quantity">
                                    <label class="visually-hidden" for="quantity-@item.ProductId">Quantity for @item.ProductName</label>
                                    <input type="hidden" name="productId" value="@item.ProductId" />
                                    <input type="number"
                                           id="quantity-@item.ProductId"
                                           name="quantity"
                                           value="@item.Quantity"
                                           min="1"
                                           class="awe-input awe-input--compact" />
                                    <button type="submit" class="awe-btn awe-btn--light awe-btn--sm">Update</button>
                                </form>
                                <form method="post" asp-action="RemoveFromCart">
                                    <input type="hidden" name="productId" value="@item.ProductId" />
                                    <button type="submit" class="awe-btn awe-btn--danger awe-btn--sm">
                                        Remove
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="awe-cart-item__meta fw-semibold">
                            $@item.Subtotal.ToString("N2")
                        </div>
                    </div>
                }

                <form method="post" asp-action="ClearCart" class="text-end">
                    <button type="submit" class="awe-btn awe-btn--danger awe-btn--sm">Clear cart</button>
                </form>
            </div>

            <div class="awe-surface awe-cart-summary">
                <h2 class="h5 mb-2">Order summary</h2>
                <div class="awe-cart-summary__row">
                    <span>Subtotal</span>
                    <span>$@subtotal.ToString("N2")</span>
                </div>
                <div class="awe-cart-summary__row">
                    <span>Estimated tax (10%)</span>
                    <span>$@tax.ToString("N2")</span>
                </div>
                <div class="awe-cart-summary__row">
                    <span>Shipping</span>
                    <span>@(shipping == 0m ? "Free" : $"${shipping.ToString("N2")}")</span>
                </div>
                <div class="awe-cart-summary__row awe-cart-summary__total pt-2 border-top">
                    <span>Total</span>
                    <span>$@grandTotal.ToString("N2")</span>
                </div>

                <a class="awe-btn awe-btn--primary awe-btn--block mt-2" asp-action="Checkout">
                    Proceed to checkout
                </a>
            </div>
        </div>
    }
</section>
