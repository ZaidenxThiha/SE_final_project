@model AWEfinal.DAL.Models.Product
@using System.Text.Json
@using System.Linq
@{
    ViewData["Title"] = "Product Details";
    var productImages = new List<string>();
    if (!string.IsNullOrEmpty(Model.Images))
    {
        try
        {
            productImages = JsonSerializer.Deserialize<List<string>>(Model.Images) ?? new List<string>();
        }
        catch
        {
            productImages = new List<string>();
        }
    }
    var defaultImage = "/images/products/placeholder.jpg";
    var mainImage = productImages.Any() ? productImages.First() : defaultImage;
}

<section class="awe-section">
    <div class="awe-section__header">
        <div>
            <h1 class="awe-section__title">@Model.Name</h1>
            <p class="awe-section__subtitle">@Model.Category</p>
        </div>
        <a class="awe-btn awe-btn--ghost" asp-action="Index">Back to products</a>
    </div>

    <div class="awe-product-detail">
        <div class="awe-product-gallery">
            <div class="awe-product-gallery__main">
                <img id="mainProductImage"
                     src="@mainImage"
                     alt="@Model.Name"
                     onerror="this.src='@defaultImage';" />
            </div>

            @if (productImages.Count > 1)
            {
                <div class="awe-product-gallery__thumbs">
                    @for (int i = 0; i < productImages.Count; i++)
                    {
                        var img = productImages[i];
                        <div class="awe-product-gallery__thumb @(i == 0 ? "is-active" : string.Empty)" data-thumb="@img">
                            <img src="@img" alt="Thumbnail for @Model.Name" loading="lazy" />
                        </div>
                    }
                </div>
            }
        </div>

        <div class="awe-surface awe-product-panel">
            <div class="awe-product-price">$@Model.Price.ToString("N2")</div>
            <div class="awe-tagline">
                Inspired by the ProductDetailPage.tsx layout—clean typography, tactile borders, and responsive sections keep the focus on the product.
            </div>

            <div class="awe-meta-grid">
                <span><strong>Category:</strong> @Model.Category</span>
                @if (!string.IsNullOrEmpty(Model.Storage))
                {
                    <span><strong>Configuration:</strong> @Model.Storage</span>
                }
                <span>
                    <strong>Status:</strong>
                    @if (Model.InStock && Model.StockQuantity > 0)
                    {
                        <span class="text-success">In stock — @Model.StockQuantity units left</span>
                    }
                    else
                    {
                        <span class="text-danger">Currently unavailable</span>
                    }
                </span>
            </div>

            <div class="awe-rating">
                @for (int i = 0; i < 5; i++)
                {
                    if (i < (int)Math.Round(Model.Rating))
                    {
                        <i class="bi bi-star-fill text-warning"></i>
                    }
                    else
                    {
                        <i class="bi bi-star text-warning"></i>
                    }
                }
                <span>@Model.Rating.ToString("0.0") / 5.0</span>
            </div>

            <p>@Model.Description</p>

            <div class="awe-cta-group">
                @if (Model.InStock && Model.StockQuantity > 0)
                {
                    <a class="awe-btn awe-btn--primary" asp-controller="Cart" asp-action="AddToCart" asp-route-productId="@Model.Id">
                        Add to cart
                    </a>
                }
                else
                {
                    <span class="awe-btn awe-btn--light is-disabled">Out of stock</span>
                }
                <a class="awe-btn awe-btn--ghost" asp-action="Index">Keep browsing</a>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        (function () {
            const main = document.getElementById('mainProductImage');
            const thumbs = document.querySelectorAll('.awe-product-gallery__thumb');
            if (!main || thumbs.length === 0) return;

            thumbs.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    const src = thumb.getAttribute('data-thumb');
                    if (!src) return;
                    main.src = src;
                    thumbs.forEach(t => t.classList.remove('is-active'));
                    thumb.classList.add('is-active');
                });
            });
        })();
    </script>
}
