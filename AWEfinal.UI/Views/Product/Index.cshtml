@model List<AWEfinal.DAL.Models.Product>
@using System.Text.Json
@using System.Linq
@{
    ViewData["Title"] = "Products";
    var categories = ViewBag.Categories as string[] ?? new[] { "All", "Smartphones", "Laptops", "Tablets", "Headphones", "Smart TVs", "Cameras", "Smartwatches", "Gaming Consoles", "Speakers", "Monitors" };
    var selectedCategory = ViewBag.SelectedCategory as string ?? "All";
    var searchTerm = ViewBag.SearchTerm as string ?? string.Empty;
    var sort = ViewBag.Sort as string ?? "price-asc";
    var previewColors = new[] { "#E8D5E8", "#C5D9E8", "#E8E8E8", "#D5E8D5" };
    var sortLabels = new Dictionary<string, string>
    {
        ["price-asc"] = "Price Increasing",
        ["price-desc"] = "Price Decreasing",
        ["name-asc"] = "Name A - Z"
    };
}

<section class="awe-section">

    <div class="awe-catalog">
        <aside class="awe-catalog__filters">
            <div class="awe-filter-card">
                <div class="awe-filter-card__header">
                    <span>Categories</span>
                </div>
                <div class="awe-filter-card__body">
                    @foreach (var category in categories)
                    {
                        var isSelected = string.Equals(selectedCategory, category, StringComparison.OrdinalIgnoreCase);
                        <a class="awe-filter-btn @(isSelected ? "is-active" : string.Empty)"
                           asp-controller="Product"
                           asp-action="Index"
                           asp-route-category="@category"
                           asp-route-searchTerm="@searchTerm"
                           asp-route-sort="@sort">
                            @category
                        </a>
                    }
                </div>
            </div>

            <div class="awe-filter-card">
                <div class="awe-filter-card__header">
                    <span>Sort by</span>
                    <i class="bi bi-sliders"></i>
                </div>
                <div class="awe-filter-card__body">
                    @foreach (var option in sortLabels)
                    {
                        var isSelected = string.Equals(sort, option.Key, StringComparison.OrdinalIgnoreCase);
                        <a class="awe-filter-btn @(isSelected ? "is-active" : string.Empty)"
                           asp-controller="Product"
                           asp-action="Index"
                           asp-route-category="@selectedCategory"
                           asp-route-searchTerm="@searchTerm"
                           asp-route-sort="@option.Key">
                            @option.Value
                        </a>
                    }
                </div>
            </div>
        </aside>

        <div class="awe-catalog__results">
            <div class="awe-results__header">
                <form method="get" asp-action="Index" class="awe-results__search">
                    <input type="hidden" name="category" value="@selectedCategory" />
                    <input type="hidden" name="sort" value="@sort" />
                    <div class="awe-search">
                        <i class="bi bi-search awe-search__icon"></i>
                        <input type="text" name="searchTerm" placeholder="Search products..." value="@searchTerm" />
                    </div>
                </form>
            </div>

            @if (Model == null || !Model.Any())
            {
                <div class="awe-empty-state">
                    <h3>No products found</h3>
                    <p class="awe-tagline">Try clearing the filters or switching categories to keep exploring.</p>
                    <a class="awe-btn awe-btn--primary mt-3" asp-controller="Product" asp-action="Index">Reset filters</a>
                </div>
            }
            else
            {
                <div class="awe-product-grid">
                    @foreach (var product in Model)
                    {
                        var productImages = new List<string>();
                        if (!string.IsNullOrEmpty(product.Images))
                        {
                            try
                            {
                                productImages = JsonSerializer.Deserialize<List<string>>(product.Images) ?? new List<string>();
                            }
                            catch
                            {
                                productImages = new List<string>();
                            }
                        }

                        var productImage = productImages.FirstOrDefault() ?? "/images/products/placeholder.jpg";
                        var inventoryCopy = product.InStock && product.StockQuantity > 0
                            ? $"{product.StockQuantity} left in stock"
                            : "Currently unavailable";

                        <div class="awe-product-card">
                            <div class="awe-product-card__media">
                                <div class="awe-product-card__image">
                                    <img src="@productImage"
                                         alt="@product.Name"
                                         loading="lazy"
                                         onerror="this.src='/images/products/placeholder.jpg';" />
                                </div>
                                <div class="awe-product-card__preview">
                                    @foreach (var color in previewColors)
                                    {
                                        <span style="background-color: @color;"></span>
                                    }
                                </div>
                            </div>

                            <div class="awe-product-card__info">
                                <div class="awe-product-card__meta">
                                    <div class="awe-product-card__name">@product.Name</div>
                                    <div class="awe-product-card__category">@product.Category</div>
                                </div>
                                <a class="awe-product-card__add js-add-to-cart"
                                   asp-controller="Cart"
                                   asp-action="AddToCart"
                                   asp-route-productId="@product.Id"
                                   data-product-id="@product.Id"
                                   title="Add to cart">
                                    <i class="bi bi-plus-lg"></i>
                                </a>
                            </div>

                            <div class="awe-product-card__price">$@product.Price.ToString("N2")</div>
                            <div class="awe-tagline">@inventoryCopy</div>

                            <div class="awe-product-card__actions">
                                <a class="awe-btn awe-btn--primary" asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">
                                    View details
                                </a>
                                @if (product.InStock && product.StockQuantity > 0)
                                {
                                    <a class="awe-btn awe-btn--light js-add-to-cart"
                                       asp-controller="Cart"
                                       asp-action="AddToCart"
                                       asp-route-productId="@product.Id"
                                       data-product-id="@product.Id">
                                        Add to cart
                                    </a>
                                }
                                else
                                {
                                    <span class="awe-btn awe-btn--light is-disabled">Out of stock</span>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</section>
