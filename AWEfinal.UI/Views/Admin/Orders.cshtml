@model List<AWEfinal.DAL.Models.Order>
@{
    ViewData["Title"] = "Order Management";
    Layout = "_AdminLayout";
    var selectedOrderId = ViewBag.SelectedOrderId as int?;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Order Management</h2>
    <form method="get" asp-action="Analytics" class="d-inline">
        <button type="submit" class="btn btn-awe-secondary">
            <i class="bi bi-calendar"></i> Monthly (Last 6 Months)
        </button>
    </form>
</div>

<div class="row">
    <!-- Order Table (Left) -->
    <div class="col-md-8">
        <div class="table-awe">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th class="px-4 py-3">Order ID</th>
                        <th class="px-4 py-3">Date</th>
                        <th class="px-4 py-3">Customer</th>
                        <th class="px-4 py-3">Total</th>
                        <th class="px-4 py-3">Status</th>
                        <th class="px-4 py-3">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var order in Model.OrderByDescending(o => o.CreatedAt))
                        {
                            <tr onclick="selectOrder(@order.Id)" style="cursor: pointer;" class="@(selectedOrderId == order.Id ? "table-active" : "")">
                                <td class="px-4 py-3">@(order.InvoiceNumber ?? order.OrderNumber ?? order.Id.ToString())</td>
                                <td class="px-4 py-3">@order.CreatedAt.ToString("MM/dd/yyyy")</td>
                                <td class="px-4 py-3">@order.ShippingFullName</td>
                                <td class="px-4 py-3">$@order.Total.ToString("N2")</td>
                                <td class="px-4 py-3">
                                    <span class="badge @GetStatusBadgeClass(order.Status)">@order.Status.ToUpper()</span>
                                </td>
                                <td class="px-4 py-3">
                                    <button type="button" class="btn btn-sm btn-link text-primary" onclick="selectOrder(@order.Id); event.stopPropagation();">
                                        View
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4">No orders found</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Order Details Panel (Right) -->
    <div class="col-md-4">
        @if (selectedOrderId.HasValue && Model != null)
        {
            var selectedOrder = Model.FirstOrDefault(o => o.Id == selectedOrderId.Value);
            if (selectedOrder != null)
            {
                <div class="stats-card">
                    <h3 class="mb-4">Order Details</h3>
                    <div class="mb-3">
                        <p class="text-muted mb-1 small">Invoice Number</p>
                        <p class="mb-0">@(selectedOrder.InvoiceNumber ?? selectedOrder.OrderNumber ?? selectedOrder.Id.ToString())</p>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted mb-1 small">Customer</p>
                        <p class="mb-0">@selectedOrder.ShippingFullName</p>
                        <p class="text-muted mb-0 small">@selectedOrder.ShippingPhone</p>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted mb-1 small">Shipping Address</p>
                        <p class="mb-0 small">@selectedOrder.ShippingAddress</p>
                        <p class="mb-0 small">@selectedOrder.ShippingCity, @selectedOrder.ShippingPostalCode</p>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted mb-1 small">Items (@selectedOrder.OrderItems.Count)</p>
                        @foreach (var item in selectedOrder.OrderItems)
                        {
                            <p class="mb-1 small">@item.ProductName x @item.Quantity</p>
                        }
                    </div>
                    <div class="mb-3">
                        <p class="text-muted mb-1 small">Total</p>
                        <p class="mb-0 fw-bold">$@selectedOrder.Total.ToString("N2")</p>
                    </div>
                    @if (!string.IsNullOrEmpty(selectedOrder.TrackingNumber))
                    {
                        <div class="mb-3">
                            <p class="text-muted mb-1 small">Tracking Number</p>
                            <p class="mb-0 small bg-light p-2 rounded">@selectedOrder.TrackingNumber</p>
                        </div>
                    }
                    <div class="mb-3">
                        <p class="text-muted mb-2 small">Update Status</p>
                        <form method="post" asp-action="UpdateOrderStatus">
                            <input type="hidden" name="orderId" value="@selectedOrder.Id" />
                            <select name="status" class="form-select mb-2" onchange="this.form.submit()">
                                <option value="pending" selected="@(selectedOrder.Status == "pending")">Pending</option>
                                <option value="paid" selected="@(selectedOrder.Status == "paid")">Paid</option>
                                <option value="packaging" selected="@(selectedOrder.Status == "packaging")">Packaging</option>
                                <option value="shipped" selected="@(selectedOrder.Status == "shipped")">Shipped</option>
                                <option value="delivered" selected="@(selectedOrder.Status == "delivered")">Delivered</option>
                                <option value="cancelled" selected="@(selectedOrder.Status == "cancelled")">Cancelled</option>
                            </select>
                            @if (selectedOrder.Status == "shipped")
                            {
                                <input type="text" name="trackingNumber" value="@selectedOrder.TrackingNumber" placeholder="Tracking #" class="form-control mb-2" />
                            }
                        </form>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="stats-card text-center py-5">
                <i class="bi bi-box-seam" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="text-muted mt-3">Select an order to view details</p>
            </div>
        }
    </div>
</div>

<!-- Summary Cards -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="stats-card text-center">
            <p class="text-muted mb-2 small">Total Orders</p>
            <p class="mb-0 fs-2 fw-bold">@(Model?.Count ?? 0)</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card text-center">
            <p class="text-muted mb-2 small">Pending</p>
            <p class="mb-0 fs-2 fw-bold">@(Model?.Count(o => o.Status == "pending" || o.Status == "paid") ?? 0)</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card text-center">
            <p class="text-muted mb-2 small">In Transit</p>
            <p class="mb-0 fs-2 fw-bold">@(Model?.Count(o => o.Status == "packaging" || o.Status == "shipped") ?? 0)</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card text-center">
            <p class="text-muted mb-2 small">Delivered</p>
            <p class="mb-0 fs-2 fw-bold">@(Model?.Count(o => o.Status == "delivered") ?? 0)</p>
        </div>
    </div>
</div>

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "pending" => "bg-warning text-dark",
            "paid" => "bg-info text-dark",
            "packaging" => "bg-purple text-white",
            "shipped" => "bg-primary",
            "delivered" => "bg-success",
            "cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}

<script>
    function selectOrder(orderId) {
        window.location.href = '@Url.Action("Orders", "Admin")?selectedOrderId=' + orderId;
    }
</script>
